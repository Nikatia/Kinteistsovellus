@model IEnumerable<Kiinteistosovellus.Models.MonthlySpendings>

@{
    ViewBag.Title = "Kuukausittaiset kulut";
}
<br />
<h2>Kuukausittaiset kulut</h2>
<br />
<div class="row">
    <div class="col-6">
        <div style="height: 338px" id="chartContainer"></div>
    </div>
    <div class="col-6">
        <div style="height: 318px" id="chartContainerBar"></div>
    </div>
</div>
<br />
<div style="margin-left:40%">@Html.DropDownList("Vuosi", (IEnumerable<SelectListItem>)ViewBag.Vuosi, null, new { @class = "form-control" })</div>

<a class="card-link ikonka" title="Uusi Kuukausittainen kulu" id="CreateMS" role="button"><img src="/Icons/square-add.svg" height="45"></a>&emsp;<a class="card-link ikonka" title="Näytä lisätiedot" id="DetailButton" role="button"><img src="/Icons/square-more-info.svg" id="moreInfo" height="45"></a>

<div id="ModalPlaceEdit"></div> @*//Tähän tulee modaalit*@
<div id="ModalPlaceDelete"></div>
<div id="ModalPlaceCreate"></div>

<div class="card border-primary" style="margin:10px 0">
    <div class="card-header bg-primary" style="color: white; font-weight: bold;">Suodatus</div>
    <div class="card-body row">
        <div class="col-md-4">
            <label class="form-label">
                Kulutyyppi
            </label>
            <div class="dropdown form-group">
                <div class="form-select form-control" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                    <div id="hidingField" style="margin-left:auto; margin-right:auto; color:gray">-- Valitse suodattimet --</div>
                </div>
                <ul style="width:100%" class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                    @{
                        var array = ViewBag.Kulutyypit;
                        foreach (var item in array)
                        {
                            <li style="width:100%"><a class="dropdown-item activate-this">@item</a></li>
                        }
                    }
                </ul>
            </div>
        </div>
        <div class="col-md-4">
            <label class="form-label">
                Alkupäivämäärä
            </label>
            <input type="date" id="beginDate" class="form-control" />
        </div>
        <div class="col-md-4">
            <label class="form-label">
                Loppupäivämäärä
            </label>
            <input type="date" id="endDate" class="form-control" />
        </div>
    </div>
</div>

<table class="table">
    <tr class="card-header bg-primary" style="color:white">
        <th>
            Aloituspvm

        </th>
        <th>
            Päättymispvm
        </th>
        <th>
            Kulutustyyppi
        </th>
        <th>
            Kokonaiskulutus
        </th>
        <th>
            Energian yksikkö
        </th>
        <th class="details" style="display: none; font-weight: bold;">
            Yksikköhinta
        </th>
        <th class="details" style="display: none; font-weight: bold;">
            Siirtomaksu
        </th>
        <th>
            Kokonaishinta
        </th>
        <th>
            Yrityksen nimi
        </th>
       

        <th></th>
    </tr>

    @foreach (var item in Model)
    {

        <tr class="card-body filtering">
            <td class="centeredTds">
                @if (item.DateBegin != null)
                {@Convert.ToDateTime(item.DateBegin).ToString("dd/MM/yyyy")}
            @*@Html.DisplayFor(modelItem => item.DateBegin)*@
            </td>
            <td class="centeredTds">
                @if (item.DateEnd != null)
                {@Convert.ToDateTime(item.DateEnd).ToString("dd/MM/yyyy")}
            @*@Html.DisplayFor(modelItem => item.DateEnd)*@
            </td>
            <td class="centeredTds">
                @Html.DisplayFor(modelItem => item.MonthlySpendingTypes.TypeName)
            </td>
            <td class="centeredTds">

                @Html.DisplayFor(modelItem => item.AmountOfUnits)
            </td>
            <td class="centeredTds">
                @Html.DisplayFor(modelItem => item.MonthlySpendingTypes.Unit)
            </td>
            <td class="details centeredTds" style="display:none;font-weight: bold;">
                @Html.DisplayFor(modelItem => item.PricePerUnit)
            </td>
            <td class="details centeredTds" style="display: none; font-weight: bold;">
                @Html.DisplayFor(modelItem => item.TransferPayment)
            </td>
            <td class="centeredTds">
                @Html.DisplayFor(modelItem => item.FullPrice)
            </td>
            <td class="centeredTds">
                @Html.DisplayFor(modelItem => item.Contractors.Name)
            </td>
            

            <td class="centeredTds">
                <a class="card-link ikonka getOrderId" title="Muokkaa Kulu" data-orderid="@item.MonthlySpendingID" role="button"><img src="/Icons/square-edit.svg" height="30"></a>
                <a class="card-link ikonka getId" title="Poista Kulu" data-id="@item.MonthlySpendingID" role="button"><img src="/Icons/square-delete.svg" height="30"></a>
            </td>
        </tr>
    }

</table>
<script type="text/javascript">

    $(function () {
        $('#homeClicked').removeClass('active');
        $('#spendingsClicked').addClass('active');
        $('#othersClicked').removeClass('active');
    });

    $(document).ready(function () {
        $(".getOrderId").click(function () {
            let MSEditId = $(this).data("orderid");

            var url = "/MonthlySpendings/_EditModal/?id=" + MSEditId;

            var $detailDivEdit = $("#ModalPlaceEdit");
            $.get(url, function (data) {
                $detailDivEdit.replaceWith(data);
                $("#ModalMSEdit").modal("show");

            });

        });
    });

    $(document).ready(function () {
        

        $(".getId").click(function () {
            let MSDeleteId = $(this).data("id");

            var url = "/MonthlySpendings/_DeleteModal/?id=" + MSDeleteId;

            var $detailDivEdit = $("#ModalPlaceDelete");
            $.get(url, function (data) {
                $detailDivEdit.replaceWith(data);
                $("#ModalMSDelete").modal("show");

            });

        });
    });
    $(document).ready(function () {
        $("#CreateMS").click(function () {
            var url = "/MonthlySpendings/_CreateModal";

            var $detailDivEdit = $("#ModalPlaceCreate");
            $.get(url, function (data) {
                $detailDivEdit.replaceWith(data);
                $("#ModalMSCreate").modal("show");

            });
        });
    });

    //Details toggle button
    $(document).ready(function () {

        $("#DetailButton").click(function () {
            $(".details").toggle();
            if ($("#DetailButton").attr('title') == "Näytä lisätiedot") {
                $("#DetailButton").attr('title', "Piilota lisätiedot");
                $("#moreInfo").attr("src", "/Icons/square-no-more-info.svg");
            }
            else {
                $("#DetailButton").attr('title', "Näytä lisätiedot");
                $("#moreInfo").attr("src", "/Icons/square-more-info.svg")
            };
        });
    });


    //On page load showes chart's partials with data for current year
    $(document).ready(async function () {
        var thisYear = new Date().getFullYear();
        document.getElementById("Vuosi").value = thisYear;
        var url = "/MonthlySpendings/Chart/?year=" + thisYear;
        var urlBar = "/MonthlySpendings/BarChart/?year=" + thisYear;
        var divForPartial = $("#chartContainer");
        var divForPartialBar = $("#chartContainerBar");
        await $.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            method: 'get',
            type: "get",
            success: function (result) {
                $(divForPartial).html("");
                $(divForPartial).html(result);
            }
        });
        await $.ajax({
            url: urlBar,
            cache: false,
            contentType: false,
            processData: false,
            method: 'get',
            type: "get",
            success: function (result) {
                $(divForPartialBar).html("");
                $(divForPartialBar).html(result);
            }
        });
    });

    //On year's dropdown change showes chart's partials with data for selected year
    $('#Vuosi').change(async function () {
        var thisYear = $(this).val();
        var url = "/MonthlySpendings/Chart/?year=" + thisYear;
        var urlBar = "/MonthlySpendings/BarChart/?year=" + thisYear;
        var divForPartial = $("#chartContainer");
        var divForPartialBar = $("#chartContainerBar");

        await $.ajax({
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            method: 'get',
            type: "get",
            success: function (result) {
                $(divForPartial).html("");
                $(divForPartial).html(result);
            }
        });

        await $.ajax({
            url: urlBar,
            cache: false,
            contentType: false,
            processData: false,
            method: 'get',
            type: "get",
            success: function (result) {
                $(divForPartialBar).html("");
                $(divForPartialBar).html(result);
            }
        });
    });


    $(".activate-this").click(function () {
        event.stopPropagation();
        if ($(this).hasClass("active")) {
            $(this).removeClass("active");
        } else {
            $(this).addClass("active");
        }
        filterTable("hidingField", "dropdownMenuButton1", "beginDate", "endDate");
    });

    $("#beginDate").change(function () {
        console.log("toimii");
        filterTable("hidingField", "dropdownMenuButton1", "beginDate", "endDate");
    });

    $("#endDate").change(function () {
        filterTable("hidingField", "dropdownMenuButton1", "beginDate", "endDate");
    });


        //$(document).ready(function () {
        //    setTimeout(function () {
        //       // localStorage.setItem('alerted', '');
        //        var alerted = localStorage.getItem('alerted') || '';
        //        if (alerted != 'yes') {
        //            alert("Kiinnostavaa? Modalin 'Takaisin' -näppäimen ominaisuus 'data-bs-dismiss='modal'' sulkee modalin. RedirectToAction -komento lataa turhaan sivun uudelleen!" Tosin ei toimi muokkaa tai poisto -toiminnoissa, koska alkuperäinen div id korvattu datalla.);
        //            localStorage.setItem('alerted', 'yes');
        //        }

        //    }, 3000);
        //});

</script>