@model Kiinteistosovellus.Models.Persons

@{
    var message = ViewBag.SuccessMsg;
}

@using (Html.BeginForm("CreatePerson", "Contractors", FormMethod.Post, new { id = "createPersonForm" }))
{
    @Html.AntiForgeryToken()

    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    <b id="yhteystiedot">Uusi henkilö<br /></b>

    <div class="form-group">
        Etunimi  @Html.ValidationMessageFor(model => model.FirstName, "", new { @class = "text-danger"})
        <div class="col-md-10">
            @Html.EditorFor(model => model.FirstName, new { htmlAttributes = new { @class = "form-control" } })
        </div>
    </div>

    <div class="form-group">
        Sukunimi  @Html.ValidationMessageFor(model => model.LastName, "", new { @class = "text-danger"})
        <div class="col-md-10">
            @Html.EditorFor(model => model.LastName, new { htmlAttributes = new { @class = "form-control" } })
        </div>
    </div>

    <div class="form-group">
        Urakoitsija  @Html.ValidationMessageFor(model => model.ContractorID, "", new { @class = "text-danger" })
        <div class="col-md-10">
            @Html.DropDownList("ContractorID", null, htmlAttributes: new { @class = "form-control", @id = "ContractorsDropdown" })
        </div>
    </div>

    <div class="form-group">
        Kuvaus
        <div class="col-md-10">
            @Html.EditorFor(model => model.Description, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
        </div>
    </div>

    @*Temporary solution for LoginID until Login system is done*@
    @Html.TextBoxFor(model => model.LoginID, "LoginID", new { @class = "form-control", @Value = ViewBag.LoginID, @Hidden = "true" })

    <div style="text-align: right; padding-right: 90px; padding-top:10px">
    <a class="btn" style="background-color: rgb(184, 214, 164); color: white" role="button" id="lisaaUusiHenkilo">Lisää henkilö</a> | <a class="card-link closeAddPerson" role="button">Sulje</a>
    </div>
}

<script type="text/javascript">

    //Submit Person
    $("#lisaaUusiHenkilo").click(function () {
        partialViewSubmit("Contractors", "CreatePerson", "divForPartialPseudo", "createPersonForm", "PersonID");
    });

    //message designates if model is valid
    var message = '@message';
    //if model is valid, close PartialView, go to successful page and reset Contacts Contractors dropdown
    if (message) {
        console.log(contractors.val());
        var personUrl = '@Url.Action("FetchPersons")';
        var persons = $('#lePerson');
        var contractor = $('#ContractorID');
        persons.empty();
        persons.append($('<option></option>').val('').text(''));
        $.getJSON(personUrl, { ID: contractor.val() }, function (data) {
            if (!data) {
                persons.empty();
            }
            persons.append($('<option></option>').val('').text(''));
            $.each(data, function (index, item) {
                persons.append($('<option></option>').val(item.Value).text(item.Text));
            });
        });
        document.getElementById("divForPartialPseudo").innerHTML = "";
        document.getElementById("successfullyAddedPerson").style.display = "inline-block";
    }

    //Repopulate this PartialView's Contractors dropdown, so empty value is first and contractor 1004 is ignored
    var contractors = $('#ContractorsDropdown');
    contractors.empty();
    contractors.append($('<option></option>').val('').text(''));
    $.getJSON(contractorUrl, function (data) {
        $.each(data, function (index, item) {
            if (item.Value != 1004) {
                contractors.append($('<option></option>').val(item.Value).text(item.Text));
            }
        });
    });

    //Make modal smaller and erase this PartialView from modal
    $(".closeAddPerson").click(function () {
        document.getElementById("yhteystiedot").style.display = "none";
        document.getElementById("lisaaUusiHiddenField").style.display = "block";
        document.getElementById("successfullyAddedPerson").style.display = "none";
        $("#modalWindow").removeClass("modal-lg");
        $("#rowDiv").removeClass("row");
        $("#colDiv1").removeClass("col-sm-6");
        $("#colDiv2").removeClass("col-sm-6");
        document.getElementById("divForPartialPseudo").innerHTML = "";
    });
</script>
